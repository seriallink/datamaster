AWSTemplateFormatVersion: '2010-09-09'
Description: Governance Stack for the Data Master Project (Lake Formation)

Resources:

  RegisterLakeLocation:
    Type: AWS::LakeFormation::Resource
    Properties:
      ResourceArn:
        Fn::Sub:
          - "arn:aws:s3:::${Bucket}"
          - Bucket: !ImportValue dm-datalake-bucket
      RoleArn: !ImportValue dm-lakeformation-role-arn
      UseServiceLinkedRole: false

  GrantLakePermissionStage:
    Type: AWS::LakeFormation::Permissions
    Properties:
      DataLakePrincipal:
        DataLakePrincipalIdentifier: !ImportValue dm-lakeformation-role-arn
      Resource:
        DatabaseResource:
          Name: !ImportValue dm-stage-db
      Permissions:
        - ALL

  GrantLakePermissionBronze:
    Type: AWS::LakeFormation::Permissions
    Properties:
      DataLakePrincipal:
        DataLakePrincipalIdentifier: !ImportValue dm-lakeformation-role-arn
      Resource:
        DatabaseResource:
          Name: !ImportValue dm-bronze-db
      Permissions:
        - ALL

  GrantLakePermissionSilver:
    Type: AWS::LakeFormation::Permissions
    Properties:
      DataLakePrincipal:
        DataLakePrincipalIdentifier: !ImportValue dm-lakeformation-role-arn
      Resource:
        DatabaseResource:
          Name: !ImportValue dm-silver-db
      Permissions:
        - ALL

  GrantLakePermissionGold:
    Type: AWS::LakeFormation::Permissions
    Properties:
      DataLakePrincipal:
        DataLakePrincipalIdentifier: !ImportValue dm-lakeformation-role-arn
      Resource:
        DatabaseResource:
          Name: !ImportValue dm-gold-db
      Permissions:
        - ALL

Outputs:

  LakeResourceArn:
    Description: Registered S3 location in Lake Formation
    Value:
      Fn::Sub:
        - "arn:aws:s3:::${Bucket}"
        - Bucket: !ImportValue dm-datalake-bucket
    Export:
      Name: dm-lakeformation-s3-arn
